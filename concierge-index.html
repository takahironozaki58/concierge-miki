<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concierge MIKI: The Road to PC Elite</title>
    <style>
        /* =========================================
           CSS Variables & Base Styles
           ========================================= */
        :root {
            --primary-color: #d4a373; /* Warm Sand */
            --secondary-color: #ccd5ae; /* Sage Green */
            --accent-color: #e9edc9; /* Light Cream */
            --bg-color: #fefae0; /* Off White */
            --text-color: #5c4d3c; /* Dark Brown */
            --error-color: #e07a5f; /* Soft Red */
            --success-color: #81b29a; /* Calm Green */
            --card-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif, 'Hiragino Maru Gothic ProN', 'Meiryo';
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            outline: none;
            transition: all 0.2s ease;
        }
        button:focus-visible {
            box-shadow: 0 0 0 3px var(--secondary-color);
        }

        /* =========================================
           Layout & Containers
           ========================================= */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-icon {
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 20px;
            padding: 0.4rem 1rem;
            font-weight: bold;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.3); }

        main {
            flex: 1;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           Components
           ========================================= */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: bold;
            width: 100%;
            margin-top: 1rem;
        }
        .btn-primary:hover { background-color: #b5c091; transform: translateY(-2px); }

        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            font-weight: bold;
        }
        .btn-secondary:hover { background-color: #d6dbad; }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            background: var(--primary-color);
            color: white;
        }

        /* Characters (SVG purely in CSS/HTML) */
        .character-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--accent-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }
        .speech-bubble {
            background: white;
            padding: 1rem;
            border-radius: 15px;
            position: relative;
            flex: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            border-width: 10px 10px 10px 0;
            border-style: solid;
            border-color: transparent white transparent transparent;
        }

        /* SVG Avatars */
        .avatar { width: 80px; height: 80px; border-radius: 50%; background: white; border: 3px solid var(--primary-color); overflow: hidden; display: flex; justify-content: center; align-items: flex-end; }
        .avatar svg { width: 100%; height: 100%; }

        /* Quiz UI */
        .quiz-header { display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 0.9rem; color: #777; }
        .scenario-box { background: #f0f4f8; padding: 1rem; border-left: 4px solid var(--primary-color); margin-bottom: 1.5rem; border-radius: 0 8px 8px 0; font-style: italic; }
        
        .interactive-area {
            border: 2px dashed var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            background: #fafafa;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
        }
        .interactive-area:focus { outline: none; border-color: var(--primary-color); background: #fff; box-shadow: 0 0 0 3px rgba(212, 163, 115, 0.2); }
        
        .key-display {
            font-family: monospace;
            font-size: 1.5rem;
            background: #333;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            min-height: 3rem;
            display: inline-block;
        }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .option-btn {
            background: white; border: 2px solid var(--accent-color); padding: 1rem;
            border-radius: var(--border-radius); font-size: 1.1rem; font-weight: bold;
            color: var(--text-color); transition: all 0.2s;
        }
        .option-btn:hover { border-color: var(--primary-color); background: #fffaf0; }

        /* Sequence UI */
        .sequence-slots { display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1rem; flex-wrap: wrap; }
        .slot { width: auto; min-width: 80px; height: 40px; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: #fff; padding: 0 10px; font-weight: bold; }
        .slot.filled { border-style: solid; border-color: var(--secondary-color); background: var(--accent-color); }
        
        .feedback {
            margin-top: 1rem; padding: 1rem; border-radius: var(--border-radius); display: none; text-align: center; font-weight: bold;
        }
        .feedback.success { background: var(--success-color); color: white; display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .feedback.error { background: var(--error-color); color: white; display: block; animation: shake 0.4s; }

        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Calendar & Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-box { background: white; padding: 1rem; border-radius: var(--border-radius); text-align: center; box-shadow: var(--shadow); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary-color); }

        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 1rem; }
        .day { aspect-ratio: 1; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #eee; font-size: 0.8rem; position: relative;}
        .day.stamped { background: var(--secondary-color); color: var(--text-color); font-weight: bold; }
        .day.stamped::after { content: 'ğŸ¨'; position: absolute; font-size: 1.2rem; opacity: 0.8; }

        /* Dictionary */
        .search-bar { width: 100%; padding: 0.8rem; border: 2px solid var(--accent-color); border-radius: var(--border-radius); margin-bottom: 1rem; font-size: 1rem; }
        .dict-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .dict-item { background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center;}
        .dict-keys { font-family: monospace; background: #eee; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: bold;}

        /* Modals/Overlays */
        #daily-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .popup-content { background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius); max-width: 400px; text-align: center; }

        .hidden { display: none !important; }
        
        .hint-text { font-size: 0.9rem; color: #666; margin-top: 0.5rem; display: none; }
        .hint-btn { background: none; color: var(--primary-color); text-decoration: underline; font-size: 0.9rem; margin-top: 0.5rem; padding: 0; }
        
        /* Dashboard Nav */
        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-title">
            <!-- Simple Hotel Icon -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 21h18"></path><path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"></path><path d="M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"></path><path d="M10 9h.01"></path><path d="M14 9h.01"></path><path d="M10 13h.01"></path><path d="M14 13h.01"></path>
            </svg>
            <span data-i18n="appTitle">Concierge MIKI</span>
        </div>
        <div class="header-controls">
            <span class="badge">XP: <span id="user-xp">0</span></span>
            <button class="btn-icon" onclick="toggleLanguage()" id="lang-btn">EN</button>
        </div>
    </header>

    <!-- Daily Login Popup -->
    <div id="daily-popup" class="hidden">
        <div class="popup-content">
            <div class="avatar" style="margin: 0 auto 1rem;">
                <!-- Master TAKA SVG -->
                <svg viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="#e0e0e0"/>
                    <path d="M30 60 Q50 90 70 60" fill="none" stroke="#555" stroke-width="4"/> <!-- Beard -->
                    <circle cx="35" cy="40" r="4" fill="#333"/>
                    <circle cx="65" cy="40" r="4" fill="#333"/>
                    <path d="M40 55 Q50 65 60 55" fill="none" stroke="#333" stroke-width="2"/> <!-- Smile -->
                    <rect x="25" y="20" width="50" height="10" fill="#222" rx="2"/> <!-- Hat brim -->
                    <rect x="35" y="5" width="30" height="15" fill="#222" rx="2"/> <!-- Hat top -->
                </svg>
            </div>
            <h3 data-i18n="masterTaka">ãƒã‚¹ã‚¿ãƒ¼TAKA</h3>
            <p id="daily-msg" style="margin: 1rem 0; font-weight: bold;"></p>
            <p id="today-trivia" style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;"></p>
            <button class="btn-primary" onclick="closePopup()" data-i18n="startWork">æ¥­å‹™é–‹å§‹</button>
        </div>
    </div>

    <main>
        <!-- HOME VIEW -->
        <div id="view-home" class="view active">
            <div class="character-container">
                <div class="avatar">
                    <!-- MIKI SVG -->
                    <svg viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="#fdebd0"/>
                        <path d="M20 50 Q50 10 80 50 L80 90 L20 90 Z" fill="#2c3e50"/> <!-- Hair/Suit back -->
                        <circle cx="50" cy="45" r="30" fill="#ffe0bd"/> <!-- Face -->
                        <path d="M30 30 Q50 15 70 30" fill="none" stroke="#2c3e50" stroke-width="8" stroke-linecap="round"/> <!-- Bangs -->
                        <circle cx="40" cy="45" r="3" fill="#333"/>
                        <circle cx="60" cy="45" r="3" fill="#333"/>
                        <path d="M42 55 Q50 62 58 55" fill="none" stroke="#e74c3c" stroke-width="3" stroke-linecap="round"/> <!-- Smile -->
                        <path d="M35 90 L50 70 L65 90" fill="#fff"/> <!-- Shirt collar -->
                        <path d="M48 70 L52 70 L50 85 Z" fill="#e74c3c"/> <!-- Tie -->
                    </svg>
                </div>
                <div class="speech-bubble">
                    <p id="miki-greeting" style="font-weight: bold;"></p>
                    <p style="font-size: 0.9rem; color: #555; margin-top: 5px;" data-i18n="mikiSub">ä»Šæ—¥ã‚‚ä¸€ç·’ã«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†ï¼</p>
                </div>
            </div>

            <div class="card">
                <h2 data-i18n="dailyMission">æœ¬æ—¥ã®æ¥­å‹™ï¼ˆãƒ‡ã‚¤ãƒªãƒ¼èª²é¡Œï¼‰</h2>
                <p data-i18n="difficultySelect">é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</p>
                <div style="display: flex; gap: 1rem; margin: 1rem 0;">
                    <button class="btn-secondary" onclick="setDifficulty('beginner')" id="diff-btn-beginner">Beginner</button>
                    <button class="btn-secondary" onclick="setDifficulty('intermediate')" id="diff-btn-intermediate">Intermediate</button>
                    <button class="btn-secondary" onclick="setDifficulty('expert')" id="diff-btn-expert">Expert</button>
                </div>
                <button class="btn-primary" onclick="startDaily()" id="start-daily-btn" data-i18n="startDaily">èª²é¡Œã‚’é–‹å§‹ã™ã‚‹</button>
            </div>

            <div class="nav-grid">
                <button class="card btn-secondary" onclick="switchView('dict')" style="text-align: left;">
                    <h3 data-i18n="navDict">ğŸ“š ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆå›³é‘‘ï¼‰</h3>
                    <p style="font-size: 0.8rem; font-weight: normal; margin-top: 5px;" data-i18n="navDictSub">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¸€è¦§ã‚’ç¢ºèª</p>
                </button>
                <button class="card btn-secondary" onclick="switchView('stats')" style="text-align: left;">
                    <h3 data-i18n="navStats">ğŸ“… ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ï¼ˆæˆç¸¾ï¼‰</h3>
                    <p style="font-size: 0.8rem; font-weight: normal; margin-top: 5px;" data-i18n="navStatsSub">å‡ºå‹¤ç°¿ã¨ã‚¹ã‚³ã‚¢ã‚’ç¢ºèª</p>
                </button>
            </div>
        </div>

        <!-- QUIZ VIEW -->
        <div id="view-quiz" class="view">
            <div class="card">
                <div class="quiz-header">
                    <span id="quiz-progress">Q 1 / 5</span>
                    <span class="badge" id="quiz-diff-badge">Beginner</span>
                </div>
                
                <div class="scenario-box">
                    <strong data-i18n="situation">ã€çŠ¶æ³ã€‘</strong>
                    <span id="quiz-scenario">ãŠå®¢æ§˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã„ã§ã™ã€‚</span>
                </div>

                <h3 id="quiz-instruction" style="margin-bottom: 1.5rem;">ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã€ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚</h3>

                <!-- Dynamic Quiz Area -->
                <div id="quiz-area"></div>

                <button class="hint-btn" onclick="toggleHint()" data-i18n="showHint">ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
                <div id="quiz-hint" class="hint-text"></div>

                <div id="quiz-feedback" class="feedback"></div>
            </div>
            <button class="btn-secondary" onclick="switchView('home')" data-i18n="abort">æ¥­å‹™ä¸­æ–­ï¼ˆãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹ï¼‰</button>
        </div>

        <!-- RESULT VIEW -->
        <div id="view-result" class="view">
            <div class="card" style="text-align: center;">
                <h2>ğŸ‰ <span data-i18n="resultTitle">æ¥­å‹™å®Œäº†ï¼</span> ğŸ‰</h2>
                <div style="margin: 2rem 0;">
                    <p data-i18n="earnedXp">ç²å¾—çµŒé¨“å€¤</p>
                    <div style="font-size: 3rem; color: var(--primary-color); font-weight: bold;">+<span id="result-xp">0</span> XP</div>
                </div>
                <div id="result-stamp-msg" style="color: var(--success-color); font-weight: bold; margin-bottom: 1rem;"></div>
                
                <h3 data-i18n="reviewList">å¾©ç¿’ãƒªã‚¹ãƒˆ</h3>
                <ul id="review-list" style="text-align: left; background: #f9f9f9; padding: 1rem 2rem; border-radius: 8px; margin-top: 1rem; margin-bottom: 2rem;">
                    <!-- ãƒŸã‚¹ã—ãŸå•é¡ŒãŒä¸¦ã¶ -->
                </ul>

                <button class="btn-primary" onclick="switchView('home')" data-i18n="backToHome">ãƒ•ãƒ­ãƒ³ãƒˆã¸æˆ»ã‚‹</button>
            </div>
        </div>

        <!-- DICTIONARY VIEW -->
        <div id="view-dict" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 data-i18n="navDict">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆå›³é‘‘ï¼‰</h2>
                    <button class="btn-secondary" onclick="switchView('home')" data-i18n="back">æˆ»ã‚‹</button>
                </div>
                <input type="text" id="dict-search" class="search-bar" placeholder="æ¤œç´¢ (ä¾‹: ã‚³ãƒ”ãƒ¼, Ctrl...)" onkeyup="filterDict()">
                <div class="dict-list" id="dict-list">
                    <!-- ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- STATS & CALENDAR VIEW -->
        <div id="view-stats" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 data-i18n="navStats">ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ï¼ˆæˆç¸¾ï¼‰</h2>
                    <button class="btn-secondary" onclick="switchView('home')" data-i18n="back">æˆ»ã‚‹</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div data-i18n="totalXp">ç´¯è¨ˆ XP</div>
                        <div class="stat-value" id="stat-xp">0</div>
                    </div>
                    <div class="stat-box">
                        <div data-i18n="loginDays">é€£ç¶šå‡ºå‹¤æ—¥æ•°</div>
                        <div class="stat-value" id="stat-days">0</div>
                    </div>
                    <div class="stat-box">
                        <div data-i18n="title">ç¾åœ¨ã®ç§°å·</div>
                        <div class="stat-value" id="stat-title" style="font-size: 1.2rem; margin-top: 0.5rem; color: var(--text-color);">è¦‹ç¿’ã„</div>
                    </div>
                </div>

                <h3 data-i18n="attendance">ä»Šæœˆã®å‡ºå‹¤ç°¿</h3>
                <div class="calendar" id="calendar-grid">
                    <!-- ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

    </main>

    <script>
        /* =========================================
           Data & State Management
           ========================================= */
        const APP_VERSION = "1.0";

        // State
        let state = {
            lang: 'ja',
            difficulty: 'beginner',
            xp: 0,
            loginDays: 0,
            lastLoginDate: '',
            dailyCompleted: false,
            stamps: [], // array of dates 'YYYY-MM-DD'
            mistakes: []
        };

        // i18n Dictionary
        const i18n = {
            ja: {
                appTitle: "Concierge MIKI",
                masterTaka: "ãƒã‚¹ã‚¿ãƒ¼TAKA",
                startWork: "æ¥­å‹™é–‹å§‹",
                mikiSub: "ä»Šæ—¥ã‚‚ä¸€ç·’ã«ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†ï¼",
                dailyMission: "æœ¬æ—¥ã®æ¥­å‹™ï¼ˆãƒ‡ã‚¤ãƒªãƒ¼èª²é¡Œï¼‰",
                difficultySelect: "é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š",
                startDaily: "èª²é¡Œã‚’é–‹å§‹ã™ã‚‹",
                navDict: "ğŸ“š ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆå›³é‘‘ï¼‰",
                navDictSub: "ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¸€è¦§ã‚’ç¢ºèª",
                navStats: "ğŸ“… ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ï¼ˆæˆç¸¾ï¼‰",
                navStatsSub: "å‡ºå‹¤ç°¿ã¨ã‚¹ã‚³ã‚¢ã‚’ç¢ºèª",
                situation: "ã€çŠ¶æ³ã€‘",
                showHint: "ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹",
                abort: "æ¥­å‹™ä¸­æ–­ï¼ˆãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹ï¼‰",
                resultTitle: "æ¥­å‹™å®Œäº†ï¼",
                earnedXp: "ç²å¾—çµŒé¨“å€¤",
                reviewList: "å¾©ç¿’ãƒªã‚¹ãƒˆï¼ˆä»Šå›é–“é•ãˆãŸæ“ä½œï¼‰",
                backToHome: "ãƒ•ãƒ­ãƒ³ãƒˆã¸æˆ»ã‚‹",
                back: "æˆ»ã‚‹",
                totalXp: "ç´¯è¨ˆ XP",
                loginDays: "é€£ç¶šå‡ºå‹¤æ—¥æ•°",
                title: "ç¾åœ¨ã®ç§°å·",
                attendance: "ä»Šæœˆã®å‡ºå‹¤ç°¿",
                perfect: "ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ç´ æ™´ã‚‰ã—ã„å¯¾å¿œã§ã™ï¼",
                completedMsg: "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã—ã¾ã—ãŸï¼",
                alreadyCompleted: "æœ¬æ—¥ã®æ¥­å‹™ã¯å®Œäº†æ¸ˆã¿ã§ã™ã€‚å¾©ç¿’ã¯ä½•åº¦ã§ã‚‚å¯èƒ½ã§ã™ï¼",
                seqClear: "ã‚¯ãƒªã‚¢",
                seqBack: "1ã¤æˆ»ã‚‹",
                simFocusMsg: "ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
                simInput: "å…¥åŠ›: ",
                simWait: "ã‚­ãƒ¼å…¥åŠ›ã‚’å¾…æ©Ÿä¸­...",
                correct: "æ­£è§£ã§ã™ï¼",
                wrong: "æƒœã—ã„ï¼ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
                titles: {
                    0: "è¦‹ç¿’ã„ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥",
                    100: "ã‚¸ãƒ¥ãƒ‹ã‚¢ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥",
                    300: "ã‚·ãƒ‹ã‚¢ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥",
                    600: "ãƒãƒ¼ãƒ•ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥",
                    1000: "PCã‚¨ãƒªãƒ¼ãƒˆãƒã‚¹ã‚¿ãƒ¼"
                },
                genericTrivia: "ãŠå®¢æ§˜ã®ç¬‘é¡”ã®ãŸã‚ã«ã€ä»Šæ—¥ã‚‚ä¸€ã¤ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’è¦šãˆã¾ã—ã‚‡ã†ï¼",
                placeholderNoMistakes: "å®Œç’§ã§ã™ï¼å¾©ç¿’ãƒªã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            },
            en: {
                appTitle: "Concierge MIKI",
                masterTaka: "Master TAKA",
                startWork: "Start Work",
                mikiSub: "Let's master PC shortcuts together today!",
                dailyMission: "Today's Mission",
                difficultySelect: "Select Difficulty:",
                startDaily: "Start Daily Tasks",
                navDict: "ğŸ“š Manual (Dictionary)",
                navDictSub: "Check shortcut list",
                navStats: "ğŸ“… Timecard (Stats)",
                navStatsSub: "Check attendance & score",
                situation: "[Situation]",
                showHint: "Show Hint",
                abort: "Abort (Back to Home)",
                resultTitle: "Mission Complete!",
                earnedXp: "Earned XP",
                reviewList: "Review List (Mistakes)",
                backToHome: "Back to Front Desk",
                back: "Back",
                totalXp: "Total XP",
                loginDays: "Consecutive Days",
                title: "Current Title",
                attendance: "This Month's Attendance",
                perfect: "Perfect! Excellent service!",
                completedMsg: "Good job! A stamp has been added to your card.",
                alreadyCompleted: "Today's tasks are done. You can review anytime!",
                seqClear: "Clear",
                seqBack: "Back",
                simFocusMsg: "Click here and type your keyboard shortcut",
                simInput: "Input: ",
                simWait: "Waiting for keyboard input...",
                correct: "Correct!",
                wrong: "Close! Let's check the hint and try again.",
                titles: {
                    0: "Apprentice Concierge",
                    100: "Junior Concierge",
                    300: "Senior Concierge",
                    600: "Chief Concierge",
                    1000: "PC Elite Master"
                },
                genericTrivia: "Learn one shortcut a day for our guests' smiles!",
                placeholderNoMistakes: "Perfect! No mistakes to review."
            }
        };

        // Trivia Data (January example + generic fallback)
        const triviaData = {
            "01-01": { ja: "å…ƒæ—¥ã€‚æ–°ã—ã„å¹´ã®å§‹ã¾ã‚Šã€PCã‚¹ã‚­ãƒ«ã‚‚ä¸€æ–°ã—ã¾ã—ã‚‡ã†ï¼", en: "New Year's Day. Start fresh with new PC skills!" },
            "01-02": { ja: "ä»•äº‹å§‹ã‚æº–å‚™ã€‚ãƒ•ã‚©ãƒ«ãƒ€æ•´ç†ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æ„è­˜ã—ã¦ã¿ã¦ã¯ï¼Ÿ", en: "Preparing for work. Time to organize your folders!" },
            "01-10": { ja: "110ç•ªã®æ—¥ã€‚ãƒˆãƒ©ãƒ–ãƒ«æ™‚ã¯è½ã¡ç€ã„ã¦ Ctrl+Zï¼ˆå…ƒã«æˆ»ã™ï¼‰ï¼", en: "Emergency call day. Stay calm and press Ctrl+Z!" },
            "02-14": { ja: "ãƒãƒ¬ãƒ³ã‚¿ã‚¤ãƒ³ãƒ‡ãƒ¼ã€‚æ„›ã‚’è¾¼ã‚ãŸãƒ¡ãƒ¼ãƒ«ã¯ Ctrl+Enter ã§é€ä¿¡ï¼", en: "Valentine's Day. Send love emails quickly!" },
            // Add more specific dates as needed...
        };

        // Quiz Database (30+ questions)
        const quizDB = [
            // --- Beginner ---
            { id: "b1", diff: "beginner", type: "simulation", 
              scenario: { ja: "ãŠå®¢æ§˜æƒ…å ±ã‚’åˆ¥ã®æ¬„ã«è»¢è¨˜ã—ãŸã„ã§ã™ã€‚", en: "Need to copy guest info to another field." },
              instruction: { ja: "é¸æŠã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œã‚³ãƒ”ãƒ¼ã€ã—ã¦ãã ã•ã„ã€‚", en: "Copy the selected text." },
              targetKeys: ["CTRL", "C"], hint: { ja: "Controlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ C ã‚’æŠ¼ã—ã¾ã™ã€‚", en: "Hold Control and press C." }
            },
            { id: "b2", diff: "beginner", type: "simulation", 
              scenario: { ja: "å…ˆã»ã©ã‚³ãƒ”ãƒ¼ã—ãŸæƒ…å ±ã‚’å…¥åŠ›æ¬„ã«å…¥ã‚ŒãŸã„ã§ã™ã€‚", en: "Need to paste the copied info." },
              instruction: { ja: "ã‚³ãƒ”ãƒ¼ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œè²¼ã‚Šä»˜ã‘ã€ã—ã¦ãã ã•ã„ã€‚", en: "Paste the text." },
              targetKeys: ["CTRL", "V"], hint: { ja: "Controlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ V ã‚’æŠ¼ã—ã¾ã™ã€‚", en: "Hold Control and press V." }
            },
            { id: "b3", diff: "beginner", type: "simulation", 
              scenario: { ja: "é•·ã„è¦ç´„æ–‡ã‚’ã™ã¹ã¦æ¶ˆã—ã¦æ›¸ãç›´ã—ãŸã„ã§ã™ã€‚", en: "Want to select the entire long text to rewrite." },
              instruction: { ja: "ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œã™ã¹ã¦é¸æŠã€ã—ã¦ãã ã•ã„ã€‚", en: "Select all text." },
              targetKeys: ["CTRL", "A"], hint: { ja: "Controlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ A ã‚’æŠ¼ã—ã¾ã™ã€‚", en: "Hold Control and press A." }
            },
            { id: "b4", diff: "beginner", type: "simulation", 
              scenario: { ja: "ã‚ï¼é–“é•ãˆã¦å¤§åˆ‡ãªæ–‡ç« ã‚’æ¶ˆã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚", en: "Oops! Accidentally deleted important text." },
              instruction: { ja: "æ“ä½œã‚’ã€Œå…ƒã«æˆ»ã—ã¦ã€ãã ã•ã„ã€‚", en: "Undo the last action." },
              targetKeys: ["CTRL", "Z"], hint: { ja: "Controlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ Z ã‚’æŠ¼ã—ã¾ã™ã€‚", en: "Hold Control and press Z." }
            },
            { id: "b5", diff: "beginner", type: "simulation", 
              scenario: { ja: "ã“ã®æ–‡ã¯ä¸‹ã®æ®µè½ã«ç§»å‹•ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚", en: "This sentence needs to be moved down." },
              instruction: { ja: "ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œåˆ‡ã‚Šå–ã‚Šã€ã—ã¦ãã ã•ã„ã€‚", en: "Cut the text." },
              targetKeys: ["CTRL", "X"], hint: { ja: "Controlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ X ã‚’æŠ¼ã—ã¾ã™ã€‚", en: "Hold Control and press X." }
            },
            { id: "b6", diff: "beginner", type: "choice", 
              scenario: { ja: "ãƒ–ãƒ©ã‚¦ã‚¶ã§èª¿ã¹ç‰©ã‚’ã—ãªãŒã‚‰ã€åˆ¥ã®èª¿ã¹ç‰©ã‚‚ã—ãŸã„ã§ã™ã€‚", en: "Want to search something else while keeping this page open." },
              instruction: { ja: "ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€Œæ–°ã—ã„ã‚¿ãƒ–ã€ã‚’é–‹ãã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ã©ã‚Œï¼Ÿ", en: "Which shortcut opens a New Tab?" },
              options: [{k: "Ctrl + T", c: true}, {k: "Ctrl + N", c: false}, {k: "Alt + T", c: false}, {k: "Win + T", c: false}],
              hint: { ja: "Tabã®é ­æ–‡å­—ã€ŒTã€ã‚’Ctrlã¨çµ„ã¿åˆã‚ã›ã¾ã™ã€‚", en: "T stands for Tab." }
            },
            { id: "b7", diff: "beginner", type: "choice", 
              scenario: { ja: "è†¨å¤§ãªå®¿æ³Šãƒªã‚¹ãƒˆã‹ã‚‰ã€Œç”°ä¸­æ§˜ã€ã‚’æ¢ã—ãŸã„ã§ã™ã€‚", en: "Need to find 'Tanaka' in a huge guest list." },
              instruction: { ja: "ãƒšãƒ¼ã‚¸å†…ã€Œæ¤œç´¢ã€ã‚’å‘¼ã³å‡ºã™ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Shortcut to Find in page?" },
              options: [{k: "Ctrl + S", c: false}, {k: "Ctrl + F", c: true}, {k: "Alt + F", c: false}, {k: "Shift + F", c: false}],
              hint: { ja: "Findï¼ˆè¦‹ã¤ã‘ã‚‹ï¼‰ã®é ­æ–‡å­—ã€ŒFã€ã§ã™ã€‚", en: "F stands for Find." }
            },
            { id: "b8", diff: "beginner", type: "choice", 
              scenario: { ja: "ä½œæˆã—ãŸè¦‹ç©æ›¸ã‚’ã“ã¾ã‚ã«ä¿å­˜ã—ãŸã„ã§ã™ã€‚", en: "Want to save the document frequently." },
              instruction: { ja: "ã€Œä¸Šæ›¸ãä¿å­˜ã€ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Shortcut to Save?" },
              options: [{k: "Ctrl + S", c: true}, {k: "Ctrl + D", c: false}, {k: "Alt + S", c: false}, {k: "Ctrl + P", c: false}],
              hint: { ja: "Saveã®é ­æ–‡å­—ã€ŒSã€ã§ã™ã€‚", en: "S stands for Save." }
            },
            { id: "b9", diff: "beginner", type: "sequence", 
              scenario: { ja: "ãƒ¡ãƒ¼ãƒ«ã‚½ãƒ•ãƒˆã‹ã‚‰Excelã¸ã€ãƒã‚¦ã‚¹ã‚’ä½¿ã‚ãšã«ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„ã§ã™ã€‚", en: "Switch from Mail to Excel without a mouse." },
              instruction: { ja: "ã€Œã‚¢ãƒ—ãƒªåˆ‡ã‚Šæ›¿ãˆã€ã®æ“ä½œé †ã«ä¸¦ã¹ã¦ãã ã•ã„ã€‚", en: "Arrange the sequence to switch apps." },
              pieces: ["Altã‚’æŠ¼ã—ãŸã¾ã¾", "Tabã‚’1å›æŠ¼ã™", "ç›®çš„ã®ã‚¢ãƒ—ãƒªã§Altã‚’é›¢ã™"],
              correctSeq: [0, 1, 2],
              hint: { ja: "Altã‚’åŸºç‚¹ã«Tabã§é¸ã³ã¾ã™ã€‚", en: "Hold Alt and tap Tab." }
            },
            { id: "b10", diff: "beginner", type: "sequence", 
              scenario: { ja: "ã“ã®å…¥åŠ›æ¬„ã®å†…å®¹ã‚’ã™ã¹ã¦ã€åˆ¥ã®æ¬„ã«æŒã£ã¦ã„ããŸã„ã§ã™ã€‚", en: "Bring all content here to another field." },
              instruction: { ja: "ã€Œã™ã¹ã¦é¸æŠã€ã—ã¦ã‹ã‚‰ã€Œã‚³ãƒ”ãƒ¼ã€ã™ã‚‹æ­£ã—ã„æ‰‹é †ã¯ï¼Ÿ", en: "Sequence for Select All then Copy?" },
              pieces: ["Ctrl + A", "Ctrl + X", "Ctrl + C"],
              correctSeq: [0, 2], // Only 2 steps needed
              hint: { ja: "All(ã™ã¹ã¦) -> Copy(ã‚³ãƒ”ãƒ¼) ã®é †ã§ã™ã€‚", en: "Select All then Copy." }
            },

            // --- Intermediate ---
            { id: "i1", diff: "intermediate", type: "choice", 
              scenario: { ja: "å·¦ã«äºˆç´„ãƒªã‚¹ãƒˆã€å³ã«ãƒ¡ãƒ¼ãƒ«ç”»é¢ã‚’ä¸¦ã¹ã¦è¦‹ãŸã„ã§ã™ã€‚", en: "Want lists on left and mail on right." },
              instruction: { ja: "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ã€Œç”»é¢å·¦åŠåˆ†ã«ã‚¹ãƒŠãƒƒãƒ—ï¼ˆé…ç½®ï¼‰ã€ã™ã‚‹ã‚­ãƒ¼ã¯ï¼Ÿ", en: "Shortcut to snap window to left half?" },
              options: [{k: "Win + â†", c: true}, {k: "Ctrl + â†", c: false}, {k: "Alt + â†", c: false}, {k: "Shift + â†", c: false}],
              hint: { ja: "Windowsã‚­ãƒ¼ã¨æ–¹å‘ã‚­ãƒ¼ã‚’ä½¿ã„ã¾ã™ã€‚", en: "Use Windows key + Arrow." }
            },
            { id: "i2", diff: "intermediate", type: "choice", 
              scenario: { ja: "ä»Šè¦‹ã¦ã„ã‚‹ãƒ›ãƒ†ãƒ«ã®HPã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã„ã§ã™ã€‚", en: "Want to copy the current website URL." },
              instruction: { ja: "ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‚’é¸æŠã€ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Shortcut to select Address Bar?" },
              options: [{k: "Ctrl + L", c: true}, {k: "Ctrl + A", c: false}, {k: "Alt + D", c: true}, {k: "Ctrl + U", c: false}], // Dual correct possibility handled by choice logic (take first true)
              hint: { ja: "Locationã®Lã€ã¾ãŸã¯Alt+Dã§ã‚‚å¯èƒ½ã§ã™ã€‚", en: "L for Location or Alt+D." }
            },
            { id: "i3", diff: "intermediate", type: "choice", 
              scenario: { ja: "ãƒ–ãƒ©ã‚¦ã‚¶ã§è¤‡æ•°ã®ã‚¿ãƒ–ã‚’é–‹ã„ã¦ã„ã¾ã™ã€‚å³ã®ã‚¿ãƒ–ã«ç§»å‹•ã—ãŸã„ã§ã™ã€‚", en: "Have multiple tabs. Want to move to the right tab." },
              instruction: { ja: "ã€Œæ¬¡ã®ã‚¿ãƒ–ã¸ç§»å‹•ã€ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Shortcut to move to next tab?" },
              options: [{k: "Ctrl + Tab", c: true}, {k: "Alt + Tab", c: false}, {k: "Ctrl + â†’", c: false}, {k: "Win + Tab", c: false}],
              hint: { ja: "Ctrlã¨Tabã®çµ„ã¿åˆã‚ã›ã§ã™ã€‚", en: "Ctrl + Tab combination." }
            },
            { id: "i4", diff: "intermediate", type: "simulation", 
              scenario: { ja: "ã€ŒHotelã€ã¨ã„ã†å˜èªã‚’ä¸€æ°—ã«é¸æŠã—ãŸã„ã§ã™ã€‚", en: "Want to select the word 'Hotel' at once." },
              instruction: { ja: "ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‹ã‚‰ã€Œå³ã«1å˜èªåˆ†é¸æŠã€ã—ã¦ãã ã•ã„ã€‚", en: "Select one word to the right." },
              targetKeys: ["CTRL", "SHIFT", "ARROWRIGHT"], hint: { ja: "Ctrl(å˜èªã‚¸ãƒ£ãƒ³ãƒ—) + Shift(é¸æŠ) + å³çŸ¢å°", en: "Ctrl(Jump) + Shift(Select) + Right Arrow" }
            },
            { id: "i5", diff: "intermediate", type: "simulation", 
              scenario: { ja: "æ–‡ç« ã‚’ç·¨é›†ä¸­ã€‚è¡Œã®æœ€å¾Œã«è¿½è¨˜ã—ãŸã„ã§ã™ã€‚", en: "Editing text. Want to add at the end of the line." },
              instruction: { ja: "ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã€Œè¡Œã®æœ«å°¾ã€ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã•ã›ã¦ãã ã•ã„ã€‚", en: "Jump cursor to End of line." },
              targetKeys: ["END"], hint: { ja: "Endã‚­ãƒ¼å˜ä½“ã‚’æ¨ã—ã¾ã™ã€‚", en: "Press the End key." }
            },
            { id: "i6", diff: "intermediate", type: "choice", 
              scenario: { ja: "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ããŸã„ã§ã™ãŒã€ç”»é¢ãŒã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã„ã£ã±ã„ã§ã™ã€‚", en: "Need to open a file on desktop, but too many windows." },
              instruction: { ja: "ä¸€ç¬ã§ã€Œãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚’è¡¨ç¤ºã€ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Shortcut to show Desktop?" },
              options: [{k: "Win + D", c: true}, {k: "Ctrl + D", c: false}, {k: "Alt + D", c: false}, {k: "Win + M", c: false}],
              hint: { ja: "Desktopã®Dã§ã™ã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨å…ƒã«æˆ»ã‚Šã¾ã™ã€‚", en: "D for Desktop." }
            },
            { id: "i7", diff: "intermediate", type: "choice", 
              scenario: { ja: "ã•ã£ãã‚³ãƒ”ãƒ¼ã—ãŸåå‰ã¨ã€ãã®å‰ã«ã‚³ãƒ”ãƒ¼ã—ãŸé›»è©±ç•ªå·ã‚’ä¸¡æ–¹è²¼ã‚Šä»˜ã‘ãŸã„ã§ã™ã€‚", en: "Want to paste two things I copied earlier." },
              instruction: { ja: "ã€Œã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã®å±¥æ­´ã€ã‚’å‘¼ã³å‡ºã™é­”æ³•ã®ã‚­ãƒ¼ã¯ï¼Ÿ", en: "Magic key to show Clipboard History?" },
              options: [{k: "Win + V", c: true}, {k: "Ctrl + V", c: false}, {k: "Ctrl + Shift + V", c: false}, {k: "Alt + V", c: false}],
              hint: { ja: "Windowsã‚­ãƒ¼ã¨Vã®çµ„ã¿åˆã‚ã›ã§ã™ã€‚ï¼ˆåˆå›ã¯è¨­å®šã‚ªãƒ³ãŒå¿…è¦ï¼‰", en: "Win key + V." }
            },
            { id: "i8", diff: "intermediate", type: "sequence", 
              scenario: { ja: "URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€éš£ã®ã‚¿ãƒ–ã®ãƒ¡ãƒ¼ãƒ«ç”»é¢ã«è²¼ã‚Šä»˜ã‘ã¾ã™ã€‚", en: "Copy URL and paste in the next tab's mail." },
              instruction: { ja: "ã‚¹ãƒ ãƒ¼ã‚ºãªæ“ä½œé †ã«ä¸¦ã¹ã¦ãã ã•ã„ã€‚", en: "Arrange for smooth operation." },
              pieces: ["Ctrl + C", "Ctrl + V", "Ctrl + Tab"],
              correctSeq: [0, 2, 1], // Copy, Switch Tab, Paste
              hint: { ja: "ã‚³ãƒ”ãƒ¼ â†’ ã‚¿ãƒ–åˆ‡æ›¿ â†’ è²¼ã‚Šä»˜ã‘", en: "Copy -> Switch Tab -> Paste" }
            },
            { id: "i9", diff: "intermediate", type: "simulation", 
              scenario: { ja: "Ctrl+Zã§æˆ»ã—ã™ãã¾ã—ãŸï¼å…ˆã»ã©ã®çŠ¶æ…‹ã«ã‚‚ã†ä¸€åº¦é€²ã‚ãŸã„ã§ã™ã€‚", en: "Undid too much! Want to redo." },
              instruction: { ja: "æ“ä½œã‚’ã€Œã‚„ã‚Šç›´ã—ï¼ˆRedoï¼‰ã€ã—ã¦ãã ã•ã„ã€‚", en: "Redo the action." },
              targetKeys: ["CTRL", "Y"], hint: { ja: "Ctrl+Zã®é€†ã¯ã€Ctrl+Yã§ã™ã€‚", en: "Opposite of Ctrl+Z is Ctrl+Y." }
            },
            { id: "i10", diff: "intermediate", type: "choice", 
              scenario: { ja: "å°‘ã—å¸­ã‚’å¤–ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã¸å‘ã‹ã„ã¾ã™ã€‚PCã‚’ä»–äººã«æ“ä½œã•ã‚Œãªã„ã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚", en: "Stepping away. Need to lock PC." },
              instruction: { ja: "ã€Œç”»é¢ã‚’ãƒ­ãƒƒã‚¯ã€ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Shortcut to Lock Screen?" },
              options: [{k: "Win + L", c: true}, {k: "Ctrl + L", c: false}, {k: "Alt + L", c: false}, {k: "Win + Lock", c: false}],
              hint: { ja: "Lock(ãƒ­ãƒƒã‚¯)ã®é ­æ–‡å­—ã€ŒLã€ã§ã™ã€‚", en: "L for Lock." }
            },

            // --- Expert ---
            { id: "e1", diff: "expert", type: "choice", 
              scenario: { ja: "äºˆç´„å‡¦ç†ç”¨ã¨ã€ãƒ¡ãƒ¼ãƒ«å¯¾å¿œç”¨ã§ã€å®Œå…¨ã«ç”»é¢ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰ã‚’åˆ†ã‘ãŸã„ã§ã™ã€‚", en: "Want to separate desktop for Booking and Mail." },
              instruction: { ja: "ã€Œæ–°ã—ã„ä»®æƒ³ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã€ã‚’è¿½åŠ ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Add new Virtual Desktop?" },
              options: [{k: "Win + Ctrl + D", c: true}, {k: "Win + Tab", c: false}, {k: "Win + Shift + D", c: false}, {k: "Ctrl + Alt + D", c: false}],
              hint: { ja: "Win + Ctrl ã« Desktopã®D ã‚’è¶³ã—ã¾ã™ã€‚", en: "Win + Ctrl + D(Desktop)." }
            },
            { id: "e2", diff: "expert", type: "choice", 
              scenario: { ja: "å…ˆã»ã©ä½œã£ãŸã€Œäºˆç´„å‡¦ç†ç”¨ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã€ã¸ã‚µãƒƒã¨ç§»å‹•ã—ãŸã„ã§ã™ã€‚", en: "Want to move to the Virtual Desktop I just created." },
              instruction: { ja: "ã€Œå³ã®ä»®æƒ³ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã¸åˆ‡ã‚Šæ›¿ãˆã€ã‚‹ã‚­ãƒ¼ã¯ï¼Ÿ", en: "Switch to right Virtual Desktop?" },
              options: [{k: "Win + Ctrl + â†’", c: true}, {k: "Win + â†’", c: false}, {k: "Alt + Tab", c: false}, {k: "Ctrl + â†’", c: false}],
              hint: { ja: "ä»®æƒ³ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é–¢é€£ã¯ Win + Ctrl ãŒåŸºæœ¬ã§ã™ã€‚", en: "Virtual desktop ops start with Win + Ctrl." }
            },
            { id: "e3", diff: "expert", type: "choice", 
              scenario: { ja: "æ¥­å‹™ãŒè½ã¡ç€ã„ãŸã®ã§ã€è¿½åŠ ã—ãŸä»®æƒ³ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚’æ¶ˆã—ãŸã„ã§ã™ã€‚", en: "Done with the extra virtual desktop. Want to close it." },
              instruction: { ja: "ã€Œç¾åœ¨ã®ä»®æƒ³ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚’é–‰ã˜ã‚‹ã€ã‚­ãƒ¼ã¯ï¼Ÿ", en: "Close current Virtual Desktop?" },
              options: [{k: "Win + Ctrl + F4", c: true}, {k: "Alt + F4", c: false}, {k: "Win + F4", c: false}, {k: "Ctrl + W", c: false}],
              hint: { ja: "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹(Alt+F4)ã®ä»®æƒ³ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆã§ã™ã€‚", en: "Like Alt+F4 but with Win+Ctrl." }
            },
            { id: "e4", diff: "expert", type: "simulation", 
              scenario: { ja: "ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ã—ã¾ã—ãŸã€‚ä¸€æ–‡å­—ãšã¤ã§ã¯ãªãã€å˜èªã”ã¨ä¸€æ°—ã«æ¶ˆã—ãŸã„ã§ã™ã€‚", en: "Typo. Want to delete the whole word at once." },
              instruction: { ja: "ã‚«ãƒ¼ã‚½ãƒ«ã®ã€Œå·¦å´ã®1å˜èªã‚’å‰Šé™¤ã€ã—ã¦ãã ã•ã„ã€‚", en: "Delete one word to the left." },
              targetKeys: ["CTRL", "BACKSPACE"], hint: { ja: "Ctrlã‚’æŠ¼ã—ãªãŒã‚‰Backspaceã§ã™ã€‚", en: "Ctrl + Backspace." }
            },
            { id: "e5", diff: "expert", type: "choice", 
              scenario: { ja: "ç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã€ä¸€éƒ¨åˆ†ã ã‘ã€‘ã‚’åˆ‡ã‚Šå–ã£ã¦ç”»åƒä¿å­˜ã—ãŸã„ã§ã™ã€‚", en: "Want to screenshot only a specific part of the screen." },
              instruction: { ja: "ã€Œç¯„å›²æŒ‡å®šã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€ã‚’èµ·å‹•ã™ã‚‹ã‚­ãƒ¼ã¯ï¼Ÿ", en: "Launch partial screenshot tool?" },
              options: [{k: "Win + Shift + S", c: true}, {k: "PrintScreen", c: false}, {k: "Alt + PrintScreen", c: false}, {k: "Ctrl + S", c: false}],
              hint: { ja: "Windowsã®Snip & Sketchãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚", en: "Calls Snip & Sketch." }
            },
            { id: "e6", diff: "expert", type: "choice", 
              scenario: { ja: "çªç„¶ã‚·ã‚¹ãƒ†ãƒ ãŒãƒ•ãƒªãƒ¼ã‚ºã—ã¾ã—ãŸï¼å¼·åˆ¶çµ‚äº†ã•ã›ãŸã„ã§ã™ã€‚", en: "System froze! Need to force quit." },
              instruction: { ja: "ã€Œã‚¿ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã‚’ä¸€ç™ºã§é–‹ãã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Open Task Manager directly?" },
              options: [{k: "Ctrl + Shift + Esc", c: true}, {k: "Ctrl + Alt + Del", c: false}, {k: "Win + X", c: false}, {k: "Alt + F4", c: false}],
              hint: { ja: "å·¦æ‰‹ã ã‘ã§æ“ä½œã§ãã‚‹ Ctrl + Shift + Esc ãŒæœ€é€Ÿã§ã™ã€‚", en: "Ctrl+Shift+Esc opens it directly." }
            },
            { id: "e7", diff: "expert", type: "choice", 
              scenario: { ja: "ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¿ãƒ–ã‚’è¡Œãéãã¦ã—ã¾ã„ã¾ã—ãŸã€‚ä¸€ã¤å·¦ã®ã‚¿ãƒ–ã«æˆ»ã‚ŠãŸã„ã§ã™ã€‚", en: "Went too far in tabs. Want to go one tab left." },
              instruction: { ja: "ã€Œå‰ã®ã‚¿ãƒ–ã¸ç§»å‹•ï¼ˆé€†é †ï¼‰ã€ã™ã‚‹ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯ï¼Ÿ", en: "Move to previous tab?" },
              options: [{k: "Ctrl + Shift + Tab", c: true}, {k: "Ctrl + â†", c: false}, {k: "Alt + Shift + Tab", c: false}, {k: "Ctrl + Backspace", c: false}],
              hint: { ja: "Shiftã‚’åŠ ãˆã‚‹ã¨ã€Œé€†æ–¹å‘ã€ã«å‹•ãã“ã¨ãŒå¤šã„ã§ã™ã€‚", en: "Adding Shift often reverses direction." }
            },
            { id: "e8", diff: "expert", type: "simulation", 
              scenario: { ja: "æ•°ç™¾è¡Œã‚ã‚‹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®ä¸€ç•ªä¸‹ã«ã„ã¾ã™ã€‚ä¸€æ°—ã«ä¸€ç•ªä¸Šã«æˆ»ã‚ŠãŸã„ã§ã™ã€‚", en: "At bottom of long manual. Want to go to top instantly." },
              instruction: { ja: "ã‚«ãƒ¼ã‚½ãƒ«ã‚’ã€Œæ–‡æ›¸ã®å…ˆé ­ã€ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã•ã›ã¦ãã ã•ã„ã€‚", en: "Jump to beginning of document." },
              targetKeys: ["CTRL", "HOME"], hint: { ja: "Ctrl + Homeã‚­ãƒ¼ã§ã™ã€‚", en: "Ctrl + Home." }
            },
            { id: "e9", diff: "expert", type: "choice", 
              scenario: { ja: "ãƒã‚¦ã‚¹ãŒå£Šã‚Œã¾ã—ãŸï¼ã‚¢ãƒ—ãƒªã®ä¸Šã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«(F)ã€ãªã©ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ããŸã„ã§ã™ã€‚", en: "Mouse broken! Want to access top menu (File, Edit, etc)." },
              instruction: { ja: "ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒãƒ¼ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã€ã‚’å½“ã¦ã‚‹ã‚­ãƒ¼ã¯ï¼Ÿ", en: "Focus on Menu Bar?" },
              options: [{k: "Alt", c: true}, {k: "Win", c: false}, {k: "Ctrl", c: false}, {k: "F1", c: false}],
              hint: { ja: "Altã‚­ãƒ¼ã‚’1å›ãƒãƒ³ã¨æŠ¼ã™ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆãŒå‡ºã¾ã™ã€‚", en: "Tap Alt once." }
            },
            { id: "e10", diff: "expert", type: "sequence", 
              scenario: { ja: "ä»®æƒ³ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã®ä½œæ¥­ãƒ•ãƒ­ãƒ¼ã€‚", en: "Virtual desktop workflow." },
              instruction: { ja: "ã€Œè¿½åŠ ã€â†’ã€Œå³ã¸ç§»å‹•ã€â†’ã€Œé–‰ã˜ã‚‹ã€ã®é †ã«ä¸¦ã¹ã¦ãã ã•ã„ã€‚", en: "Sequence: Add -> Move Right -> Close." },
              pieces: ["Win + Ctrl + D", "Win + Ctrl + â†’", "Win + Ctrl + F4"],
              correctSeq: [0, 1, 2],
              hint: { ja: "Create(D) -> Move(Arrow) -> Close(F4)", en: "Create(D) -> Move(Arrow) -> Close(F4)" }
            }
        ];

        // --- Core Functions ---

        function init() {
            loadState();
            applyLanguage();
            checkDailyLogin();
            updateStatsUI();
            
            // Generate Dictionary
            renderDictionary();
            // Generate Calendar
            renderCalendar();

            // Event Listeners for simulation
            document.addEventListener('keydown', handleSimulationInput);
        }

        function t(key, nestedKey = null) {
            let val = i18n[state.lang][key];
            if(nestedKey && val && val[nestedKey]) return val[nestedKey];
            return val || key;
        }

        function toggleLanguage() {
            state.lang = state.lang === 'ja' ? 'en' : 'ja';
            saveState();
            applyLanguage();
            if(document.getElementById('view-quiz').classList.contains('active') && currentQuiz) {
                renderQuizUI(); // Re-render quiz in new lang
            }
            renderDictionary();
        }

        function applyLanguage() {
            document.getElementById('lang-btn').innerText = state.lang === 'ja' ? 'EN' : 'JA';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[state.lang][key]) {
                    el.innerText = i18n[state.lang][key];
                }
            });
            updateGreeting();
        }

        function getTodayString() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        function getMDString() {
            const d = new Date();
            return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function checkDailyLogin() {
            const today = getTodayString();
            if (state.lastLoginDate !== today) {
                // New day
                if(state.lastLoginDate) {
                    // Check if consecutive
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yStr = `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,'0')}-${String(yesterday.getDate()).padStart(2,'0')}`;
                    if(state.lastLoginDate === yStr) {
                        state.loginDays++;
                    } else {
                        state.loginDays = 1;
                    }
                } else {
                    state.loginDays = 1;
                }
                state.lastLoginDate = today;
                state.dailyCompleted = false;
                saveState();
                
                showDailyPopup();
            } else {
                updateGreeting();
            }
        }

        function showDailyPopup() {
            const md = getMDString();
            let trivia = triviaData[md] ? triviaData[md][state.lang] : t('genericTrivia');
            document.getElementById('daily-msg').innerText = `${state.loginDays}æ—¥é€£ç¶šå‡ºå‹¤ã§ã™ã­ï¼`;
            document.getElementById('today-trivia').innerText = trivia;
            document.getElementById('daily-popup').classList.remove('hidden');
        }

        function closePopup() {
            document.getElementById('daily-popup').classList.add('hidden');
            updateGreeting();
        }

        function updateGreeting() {
            const titles = i18n[state.lang].titles;
            let currentTitle = titles[0];
            const xpPoints = [1000, 600, 300, 100];
            for(let pt of xpPoints) {
                if(state.xp >= pt) { currentTitle = titles[pt]; break; }
            }
            document.getElementById('stat-title').innerText = currentTitle;
            
            let greeting = state.lang === 'ja' ? 
                `ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€${currentTitle}ï¼` : 
                `Good morning, ${currentTitle}!`;
            document.getElementById('miki-greeting').innerText = greeting;
        }

        // --- Navigation ---
        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            if(viewName === 'stats') {
                renderCalendar();
                updateStatsUI();
            }
        }

        function setDifficulty(diff) {
            state.difficulty = diff;
            saveState();
            document.querySelectorAll('[id^="diff-btn-"]').forEach(btn => {
                btn.style.boxShadow = 'none';
                btn.style.border = 'none';
            });
            document.getElementById(`diff-btn-${diff}`).style.boxShadow = '0 0 0 3px var(--primary-color)';
        }

        // --- Game Logic ---
        let currentDailyPool = [];
        let currentQuizIndex = 0;
        let currentQuiz = null;
        let sessionMistakes = [];
        let sessionSequence = []; // for sequence type

        function startDaily() {
            if(state.dailyCompleted) {
                if(!confirm(t('alreadyCompleted'))) return;
            }
            
            // Select questions based on difficulty
            const pool = quizDB.filter(q => q.diff === state.difficulty);
            // Shuffle and pick 3-5
            currentDailyPool = pool.sort(() => 0.5 - Math.random()).slice(0, 5);
            currentQuizIndex = 0;
            sessionMistakes = [];
            
            switchView('quiz');
            renderQuizUI();
        }

        function renderQuizUI() {
            if(currentQuizIndex >= currentDailyPool.length) {
                finishDaily();
                return;
            }

            currentQuiz = currentDailyPool[currentQuizIndex];
            
            document.getElementById('quiz-progress').innerText = `Q ${currentQuizIndex + 1} / ${currentDailyPool.length}`;
            document.getElementById('quiz-diff-badge').innerText = currentQuiz.diff.toUpperCase();
            document.getElementById('quiz-scenario').innerText = currentQuiz.scenario[state.lang];
            document.getElementById('quiz-instruction').innerText = currentQuiz.instruction[state.lang];
            
            document.getElementById('quiz-hint').style.display = 'none';
            document.getElementById('quiz-hint').innerText = currentQuiz.hint[state.lang];
            
            const area = document.getElementById('quiz-area');
            area.innerHTML = '';
            document.getElementById('quiz-feedback').className = 'feedback';
            document.getElementById('quiz-feedback').innerText = '';

            if (currentQuiz.type === 'choice') {
                const grid = document.createElement('div');
                grid.className = 'options-grid';
                // Shuffle options
                const opts = [...currentQuiz.options].sort(() => 0.5 - Math.random());
                opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = opt.k;
                    btn.onclick = () => handleChoice(opt.c);
                    grid.appendChild(btn);
                });
                area.appendChild(grid);
            } 
            else if (currentQuiz.type === 'sequence') {
                sessionSequence = [];
                const container = document.createElement('div');
                
                const slotsArea = document.createElement('div');
                slotsArea.className = 'sequence-slots';
                slotsArea.id = 'seq-slots';
                for(let i=0; i<currentQuiz.correctSeq.length; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    slotsArea.appendChild(slot);
                }
                container.appendChild(slotsArea);

                const controls = document.createElement('div');
                controls.style.textAlign = 'center';
                controls.style.marginBottom = '1rem';
                controls.innerHTML = `
                    <button class="btn-secondary" onclick="clearSequence()" style="margin-right:10px">${t('seqClear')}</button>
                    <button class="btn-secondary" onclick="popSequence()">${t('seqBack')}</button>
                `;
                container.appendChild(controls);

                const piecesGrid = document.createElement('div');
                piecesGrid.className = 'options-grid';
                currentQuiz.pieces.forEach((piece, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.innerText = piece;
                    btn.onclick = () => pushSequence(idx, piece);
                    piecesGrid.appendChild(btn);
                });
                container.appendChild(piecesGrid);
                
                area.appendChild(container);
            }
            else if (currentQuiz.type === 'simulation') {
                const simBox = document.createElement('div');
                simBox.className = 'interactive-area';
                simBox.tabIndex = 0; // Make it focusable
                simBox.innerHTML = `
                    <p style="color:#888; margin-bottom:1rem;">${t('simFocusMsg')}</p>
                    <div class="key-display" id="sim-key-display">${t('simWait')}</div>
                `;
                area.appendChild(simBox);
                setTimeout(() => simBox.focus(), 100); // Auto focus
            }
        }

        function toggleHint() {
            const h = document.getElementById('quiz-hint');
            h.style.display = h.style.display === 'block' ? 'none' : 'block';
        }

        function showFeedback(isCorrect) {
            const fb = document.getElementById('quiz-feedback');
            if (isCorrect) {
                fb.innerText = t('correct');
                fb.className = 'feedback success';
                setTimeout(() => {
                    currentQuizIndex++;
                    renderQuizUI();
                }, 1000);
            } else {
                fb.innerText = t('wrong');
                fb.className = 'feedback error';
                if(!sessionMistakes.includes(currentQuiz)) {
                    sessionMistakes.push(currentQuiz);
                }
                // Show hint automatically on wrong
                document.getElementById('quiz-hint').style.display = 'block';
            }
        }

        // Choice Logic
        function handleChoice(isCorrect) {
            showFeedback(isCorrect);
        }

        // Sequence Logic
        function pushSequence(idx, text) {
            if(sessionSequence.length < currentQuiz.correctSeq.length) {
                sessionSequence.push(idx);
                updateSeqUI();
                if(sessionSequence.length === currentQuiz.correctSeq.length) {
                    checkSequence();
                }
            }
        }
        function popSequence() {
            sessionSequence.pop();
            updateSeqUI();
        }
        function clearSequence() {
            sessionSequence = [];
            updateSeqUI();
        }
        function updateSeqUI() {
            const slots = document.getElementById('seq-slots').children;
            for(let i=0; i<slots.length; i++) {
                if(i < sessionSequence.length) {
                    slots[i].innerText = currentQuiz.pieces[sessionSequence[i]];
                    slots[i].classList.add('filled');
                } else {
                    slots[i].innerText = '';
                    slots[i].classList.remove('filled');
                }
            }
        }
        function checkSequence() {
            const isCorrect = JSON.stringify(sessionSequence) === JSON.stringify(currentQuiz.correctSeq);
            showFeedback(isCorrect);
            if(!isCorrect) {
                setTimeout(clearSequence, 1500);
            }
        }

        // Simulation Logic
        function handleSimulationInput(e) {
            if(document.getElementById('view-quiz').classList.contains('active') && currentQuiz && currentQuiz.type === 'simulation') {
                // Only process if focus is inside interactive area or body
                const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';
                if(isInput) return;

                e.preventDefault(); // Prevent default browser actions for shortcuts

                const pressedKeys = [];
                if(e.ctrlKey) pressedKeys.push("CTRL");
                if(e.shiftKey) pressedKeys.push("SHIFT");
                if(e.altKey) pressedKeys.push("ALT");
                if(e.metaKey) pressedKeys.push("WIN");
                
                let keyName = e.key.toUpperCase();
                // Normalize keys
                if(keyName === "CONTROL" || keyName === "SHIFT" || keyName === "ALT" || keyName === "META") {
                    // modifier only, wait for next key
                    return; 
                }
                pressedKeys.push(keyName);

                const displayStr = pressedKeys.join(" + ");
                const dispEl = document.getElementById('sim-key-display');
                if(dispEl) {
                    dispEl.innerText = t('simInput') + displayStr;
                }

                // Check answer
                const target = [...currentQuiz.targetKeys].sort();
                const input = [...pressedKeys].sort();
                
                if(JSON.stringify(target) === JSON.stringify(input)) {
                    showFeedback(true);
                } else {
                    // Check if they pressed enough keys
                    if(pressedKeys.length >= currentQuiz.targetKeys.length) {
                        showFeedback(false);
                    }
                }
            }
        }

        // --- Finish & Result ---
        function finishDaily() {
            const gainedXP = currentDailyPool.length * 10 - (sessionMistakes.length * 5);
            const finalXP = Math.max(0, gainedXP);
            
            state.xp += finalXP;
            
            if(!state.dailyCompleted) {
                const today = getTodayString();
                if(!state.stamps.includes(today)) {
                    state.stamps.push(today);
                }
                state.dailyCompleted = true;
                document.getElementById('result-stamp-msg').innerText = t('completedMsg');
            } else {
                document.getElementById('result-stamp-msg').innerText = "";
            }

            // Save mistakes for dict
            sessionMistakes.forEach(m => {
                if(!state.mistakes.includes(m.id)) state.mistakes.push(m.id);
            });

            saveState();

            document.getElementById('result-xp').innerText = finalXP;
            
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '';
            if(sessionMistakes.length === 0) {
                reviewList.innerHTML = `<li>${t('placeholderNoMistakes')}</li>`;
            } else {
                sessionMistakes.forEach(m => {
                    let li = document.createElement('li');
                    li.style.marginBottom = '10px';
                    let ansStr = m.type === 'simulation' ? m.targetKeys.join(' + ') : 
                                 m.type === 'choice' ? m.options.find(o=>o.c).k : 
                                 m.correctSeq.map(i => m.pieces[i]).join(' â†’ ');
                    li.innerHTML = `<strong>${m.instruction[state.lang]}</strong><br><span style="color:var(--error-color);">${ansStr}</span>`;
                    reviewList.appendChild(li);
                });
            }

            switchView('result');
            updateStatsUI();
        }

        // --- Dictionary ---
        function renderDictionary() {
            const list = document.getElementById('dict-list');
            list.innerHTML = '';
            
            quizDB.forEach(q => {
                const item = document.createElement('div');
                item.className = 'dict-item';
                item.setAttribute('data-search', (q.instruction['ja'] + q.instruction['en'] + q.scenario['ja'] + q.scenario['en']).toLowerCase());
                
                let keysStr = "";
                if(q.type === 'simulation') keysStr = q.targetKeys.join(' + ');
                else if(q.type === 'choice') {
                    const corr = q.options.find(o=>o.c);
                    keysStr = corr ? corr.k : "";
                }
                else if(q.type === 'sequence') keysStr = "æ‰‹é † (Sequence)";

                item.innerHTML = `
                    <div>
                        <div style="font-size:0.8rem; color:#888;">[${q.diff.toUpperCase()}]</div>
                        <div style="font-weight:bold;">${q.instruction[state.lang]}</div>
                        <div style="font-size:0.9rem; color:#555;">${q.scenario[state.lang]}</div>
                    </div>
                    <div class="dict-keys">${keysStr}</div>
                `;
                list.appendChild(item);
            });
        }

        function filterDict() {
            const q = document.getElementById('dict-search').value.toLowerCase();
            document.querySelectorAll('.dict-item').forEach(item => {
                const txt = item.getAttribute('data-search');
                const keys = item.querySelector('.dict-keys').innerText.toLowerCase();
                if(txt.includes(q) || keys.includes(q)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // --- Stats & Calendar ---
        function updateStatsUI() {
            document.getElementById('user-xp').innerText = state.xp;
            document.getElementById('stat-xp').innerText = state.xp;
            document.getElementById('stat-days').innerText = state.loginDays;
            
            // Highlight diff button
            setTimeout(() => setDifficulty(state.difficulty), 100);
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const d = new Date();
            const year = d.getFullYear();
            const month = d.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
            
            // Empty slots for start
            for(let i=0; i<firstDay; i++) {
                let empty = document.createElement('div');
                grid.appendChild(empty);
            }
            
            // Days
            for(let i=1; i<=daysInMonth; i++) {
                let dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.innerText = i;
                
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                if(state.stamps.includes(dateStr)) {
                    dayDiv.classList.add('stamped');
                }
                
                grid.appendChild(dayDiv);
            }
        }

        // --- LocalStorage ---
        function saveState() {
            localStorage.setItem('conciergeMikiState', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('conciergeMikiState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                } catch(e) { console.error("Save data corrupted"); }
            }
        }

        // Boot
        window.onload = init;

    </script>
</body>
</html>